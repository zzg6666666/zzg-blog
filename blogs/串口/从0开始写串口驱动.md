---
title: UART驱动
date: 2024/4/29
tags:
 - uart
categories:
 - 驱动
---

### 硬件定义

翻阅管脚定义图可以看到，USART1_TX对应的引脚为PA9，USART1_RX对应的引脚为PA10。

![pkibLp4.png](https://s21.ax1x.com/2024/04/28/pkibLp4.png)

USART的硬件框图：

![pkiqJun.png](https://s21.ax1x.com/2024/04/28/pkiqJun.png)


## 功能引脚

**TX**：发送数据输出引脚

**RX**：接收数据输入引脚

**SW_RX**：数据接收引脚，内部引脚，只用于单线和智能卡模式

**nRTS**：发送请求输出端，n表示低电平有效。如果是能RTS流控制，当USART接收器准备好接收新的数据时会将nRTS编程低电平；当接收寄存器已满时，nRTS将会被设置为高电平，该引脚只适用于硬件流控制。

**nCTS**：请求发送输入端，n表示低电平有效。如果使能CTS流控制，发送器在发送下一帧数据之前会检测nCTS引脚，如果为低电平则发送数据，如果为高电平则在发送完当前数据之后停止发送，该引脚只适用于硬件流控制。

SCLK：发送器时钟输出引脚，仅适用于同步模式。

## 寄存器

### 状态寄存器(USART_SR)

地址偏移：0x00，复位值：0x00C0

该寄存器总共有32位，31-10位未使用，为保留位，硬件强制为0。串口驱动暂时只用到这几位

**位7**:TXE:发送数据寄存器空,当发送数据寄存器为空为1

**位6**:TC：发送完成 ，发送完成为1

**位5**:RXNE：读取数据寄存器不为空,数据可以读出为1

### (USART数据寄存器)USART_DR

地址偏移：0x04

包括(发送数据寄存器)TDR和(接受数据寄存器)RDR，31:9位保留，强制为0

DR[8:0]：数据值 (Data value)

### 波特比率寄存器(USART_BRR)

地址偏移：0x00，复位值：0x0000

31:16位强制为0,15:4是USARTDIV的整数部分 ,位3:0是小数部位,计算公式:Baud = Fck/(16 *USARTDIV)

### 控制寄存器 1(USART_CR1)

地址偏移：0x0C

位31:14 保留,强制为0

位13: UE: USART使能，USART模块使能为1

位12: M: 字长，0：一个起始位，8个数据位，n个停止位。1：一个起始位，9个数据位，一个停止位

位11: WAKE: 唤醒的方法，0：被空闲总线唤醒，1：被地址标记唤醒

位10: PCE: 检验控制使能，可以使能奇偶控制

***需要注意的是，需要先关闭USART使能，才可以配置其他寄存器。因此需要先关闭使能，配置好其他寄存，最后再配置该寄存器***

### 控制寄存器 2(USART_CR2)

### 控制寄存器 3(USART_CR3)

地址偏移：0x10



## 数据线

PWDATA和PRDATA，通过PWDATA向(发送数据寄存器)TDR写数据，当发送移位寄存器空了之后，TDR会自动将数据移到发送移位寄存器。
